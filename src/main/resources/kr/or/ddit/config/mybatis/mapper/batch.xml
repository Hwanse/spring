<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="batch">
	
	<select id="getCycleList" resultType="cycleVO">
		SELECT	*
		FROM	CYCLE
	</select>  

	<insert id="mergeDaily" parameterType="dailyVO">
		MERGE INTO DAILY
			USING	DUAL ON(
				DAILY.PID = #{pid} AND
				DAILY.CID = #{cid} AND
				DAILY.DT = #{dt}
			)
			WHEN MATCHED THEN UPDATE SET
				CNT = #{cnt}
			WHEN NOT MATCHED THEN 
			INSERT (pid, cid, dt, cnt)
			VALUES ( #{pid}, #{cid}, #{dt}, #{cnt} )
	</insert>
		
	<insert id="createDaily" parameterType="string">
	<![CDATA[
		insert into daily
		select  cycle.cid, cycle.pid, cal.dt, cycle.cnt
		from    cycle, (select  to_char(to_date(#{ym}, 'yyyyMM') + (level - 1), 'yyyyMMdd') dt
		                       ,to_char(to_date(#{ym}, 'yyyyMM') + (level - 1), 'd') day
		                        from    dual
		                        connect by level <= last_day(to_date(#{ym}, 'yyyyMM')) - to_date(#{ym}, 'yyyyMM') + 1) cal
		where   cycle.day = cal.day
		order by cycle.cid, cycle.pid, cal.dt
	]]>
	</insert>	
		
	<delete id="deleteDaily" parameterType="string">
		delete	daily
		where	dt like #{ym} || '%'
	</delete>
		
	<insert id="insertBatch" parameterType="batchVO">
		<selectKey keyColumn="bid" keyProperty="bid" resultType="int" order="BEFORE">
			select	seq_batch.nextval bid from dual
		</selectKey>
		insert into batch values(#{bid}, #{bcd}, #{st}, sysdate, null)
	</insert>
	
	<update id="updateBatch" parameterType="batchVO">
		update batch set st = #{st},
						 ed_dt = sysdate
		where	bid = #{bid}
	</update>
	
</mapper>