<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="batch">
	
	<select id="getCycleList" resultType="cycleVO">
		SELECT	*
		FROM	CYCLE
	</select>  

	<insert id="mergeDaily" parameterType="dailyVO">
		MERGE INTO DAILY
			USING	DUAL ON(
				DAILY.PID = #{pid} AND
				DAILY.CID = #{cid} AND
				DAILY.DT = #{dt}
			)
			WHEN MATCHED THEN UPDATE SET
				CNT = #{cnt}
			WHEN NOT MATCHED THEN 
			INSERT (pid, cid, dt, cnt)
			VALUES ( #{pid}, #{cid}, #{dt}, #{cnt} )
	</insert>
		
	<delete id="deleteDaily" parameterType="string">
		DELETE	DAILY
		WHERE	DT LIKE #{ym} || '%'
	</delete>
		
	<insert id="createDaily" parameterType="string">
	<![CDATA[
		INSERT INTO DAILY
		SELECT  CYCLE.CID, CYCLE.PID, CAL.DT, CYCLE.CNT
		FROM    CYCLE, (SELECT  TO_CHAR(TO_DATE(#{ym}, 'yyyyMM') + (LEVEL - 1), 'yyyyMMdd') DT
		                       ,TO_CHAR(TO_DATE(#{ym}, 'yyyyMM') + (LEVEL - 1), 'D') DAY
		                        FROM    DUAL
		                        CONNECT BY LEVEL <= LAST_DAY(TO_DATE(#{ym}, 'yyyyMM')) - TO_DATE(#{ym}, 'yyyyMM') + 1) CAL
		WHERE   CYCLE.DAY = CAL.DAY
		ORDER BY CYCLE.CID, CYCLE.PID, CAL.DT
	]]>
	</insert>
</mapper>